---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { Card } from '../../components/ui/card';
import { Separator } from '../../components/ui/separator';
import { Book, ChevronRight, Home } from 'lucide-react';

export async function getStaticPaths() {
  const docs = await getCollection('docs');
  return docs.map((doc) => ({
    params: { slug: doc.slug },
    props: { doc },
  }));
}

const { doc } = Astro.props;
const { Content } = await doc.render();

// Get all docs for sidebar navigation
const allDocs = await getCollection('docs');

// Group docs by category
const docsByCategory = allDocs.reduce((acc, doc) => {
  const category = doc.data.category || 'guides';
  if (!acc[category]) acc[category] = [];
  acc[category].push(doc);
  return acc;
}, {} as Record<string, typeof allDocs>);

// Sort docs within each category by order
Object.keys(docsByCategory).forEach((category) => {
  docsByCategory[category].sort((a, b) => {
    const orderA = a.data.order ?? 999;
    const orderB = b.data.order ?? 999;
    return orderA - orderB;
  });
});

const categoryLabels: Record<string, string> = {
  settings: 'Settings',
  setup: 'Setup Guides',
  guides: 'Guides',
};
---

<Layout title={`${doc.data.title} - Summit AI Notes Documentation`} description={doc.data.description}>
  <div class="min-h-screen bg-gradient-to-br from-background via-background to-muted/20">
    <div class="container mx-auto px-4 py-8">
      <div class="max-w-7xl mx-auto">
        <!-- Breadcrumb -->
        <div class="flex items-center gap-2 text-sm text-muted-foreground mb-6">
          <a href="/" class="hover:text-foreground transition-colors flex items-center gap-1">
            <Home class="w-4 h-4" />
            Home
          </a>
          <ChevronRight class="w-4 h-4" />
          <a href="/docs" class="hover:text-foreground transition-colors">Documentation</a>
          {doc.data.category && (
            <>
              <ChevronRight class="w-4 h-4" />
              <span class="capitalize">{categoryLabels[doc.data.category] || doc.data.category}</span>
            </>
          )}
          <ChevronRight class="w-4 h-4" />
          <span class="text-foreground font-medium">{doc.data.title}</span>
        </div>

        <div class="grid lg:grid-cols-[280px_1fr] gap-8">
          <!-- Sidebar Navigation -->
          <aside class="lg:sticky lg:top-8 lg:self-start">
            <Card className="p-6">
              <div class="flex items-center gap-2 mb-6">
                <Book class="w-5 h-5 text-blue-600" />
                <h2 class="text-lg font-semibold text-foreground">Documentation</h2>
              </div>

              <nav class="space-y-6">
                {Object.entries(docsByCategory).map(([category, docs]) => (
                  <div>
                    <h3 class="text-sm font-semibold text-foreground mb-2 uppercase tracking-wide">
                      {categoryLabels[category] || category}
                    </h3>
                    <ul class="space-y-1">
                      {docs.map((navDoc) => {
                        const isActive = navDoc.slug === doc.slug;
                        return (
                          <li>
                            <a
                              href={`/docs/${navDoc.slug}`}
                              class={`block px-3 py-2 rounded-md text-sm transition-colors ${
                                isActive
                                  ? 'bg-blue-50 text-blue-600 font-medium'
                                  : 'text-muted-foreground hover:text-foreground hover:bg-muted/50'
                              }`}
                            >
                              {navDoc.data.title}
                            </a>
                          </li>
                        );
                      })}
                    </ul>
                  </div>
                ))}
              </nav>
            </Card>
          </aside>

          <!-- Main Content -->
          <main>
            <Card className="p-8 lg:p-12">
              <!-- Page Header -->
              <header class="mb-8">
                <h1 class="text-4xl font-bold text-foreground mb-4">{doc.data.title}</h1>
                <p class="text-xl text-muted-foreground">{doc.data.description}</p>
                {doc.data.lastUpdated && (
                  <p class="text-sm text-muted-foreground mt-4">
                    Last updated: {doc.data.lastUpdated.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
                  </p>
                )}
              </header>

              <Separator className="mb-8" />

              <!-- MDX Content -->
              <article class="prose prose-slate max-w-none
                prose-headings:text-foreground prose-headings:font-bold
                prose-h2:text-2xl prose-h2:mt-8 prose-h2:mb-4
                prose-h3:text-xl prose-h3:mt-6 prose-h3:mb-3
                prose-h4:text-lg prose-h4:mt-4 prose-h4:mb-2
                prose-p:text-muted-foreground prose-p:leading-relaxed
                prose-a:text-blue-600 prose-a:no-underline hover:prose-a:underline
                prose-strong:text-foreground prose-strong:font-semibold
                prose-code:text-foreground prose-code:bg-muted prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:text-sm prose-code:font-mono prose-code:before:content-none prose-code:after:content-none
                prose-pre:bg-muted prose-pre:border prose-pre:border-border
                prose-ul:text-muted-foreground prose-ul:my-4
                prose-ol:text-muted-foreground prose-ol:my-4
                prose-li:my-1
                prose-table:text-sm
                prose-th:text-foreground prose-th:font-semibold
                prose-td:text-muted-foreground
                prose-blockquote:border-l-blue-600 prose-blockquote:bg-blue-50 prose-blockquote:py-2 prose-blockquote:px-4 prose-blockquote:not-italic
                prose-blockquote:text-muted-foreground
                prose-img:rounded-lg prose-img:shadow-md
              ">
                <Content />
              </article>
            </Card>

            <!-- Footer Navigation -->
            <div class="mt-8 grid md:grid-cols-2 gap-4">
              <!-- Previous Page -->
              {(() => {
                const currentCategory = doc.data.category || 'guides';
                const categoryDocs = docsByCategory[currentCategory];
                const currentIndex = categoryDocs.findIndex(d => d.slug === doc.slug);
                const prevDoc = currentIndex > 0 ? categoryDocs[currentIndex - 1] : null;

                return prevDoc ? (
                  <a href={`/docs/${prevDoc.slug}`} class="group">
                    <Card className="p-4 hover:shadow-lg transition-shadow h-full">
                      <div class="text-sm text-muted-foreground mb-1">Previous</div>
                      <div class="font-semibold text-foreground group-hover:text-blue-600 transition-colors">
                        {prevDoc.data.title}
                      </div>
                    </Card>
                  </a>
                ) : <div />;
              })()}

              <!-- Next Page -->
              {(() => {
                const currentCategory = doc.data.category || 'guides';
                const categoryDocs = docsByCategory[currentCategory];
                const currentIndex = categoryDocs.findIndex(d => d.slug === doc.slug);
                const nextDoc = currentIndex < categoryDocs.length - 1 ? categoryDocs[currentIndex + 1] : null;

                return nextDoc ? (
                  <a href={`/docs/${nextDoc.slug}`} class="group">
                    <Card className="p-4 hover:shadow-lg transition-shadow h-full text-right">
                      <div class="text-sm text-muted-foreground mb-1">Next</div>
                      <div class="font-semibold text-foreground group-hover:text-blue-600 transition-colors">
                        {nextDoc.data.title}
                      </div>
                    </Card>
                  </a>
                ) : <div />;
              })()}
            </div>
          </main>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  /* Dark mode prose overrides */
  :global(.dark) .prose {
    --tw-prose-body: var(--muted-foreground);
    --tw-prose-headings: var(--foreground);
    --tw-prose-links: rgb(59 130 246);
    --tw-prose-bold: var(--foreground);
    --tw-prose-code: var(--foreground);
    --tw-prose-quotes: var(--muted-foreground);
    --tw-prose-th-borders: var(--border);
    --tw-prose-td-borders: var(--border);
  }

  /* Responsive sidebar on mobile */
  @media (max-width: 1023px) {
    aside {
      position: static;
    }
  }
</style>
